# Experiment Log (실험 일지)

This is a record of an experiment to improve the separation of electric guitar and bass. 
All audio files are stored on external storage (e.g., Google Drive) and can be listened to via the link.
일렉트릭 기타와 베이스 분리 성능 향상을 위한 실험 기록입니다.
모든 오디오 파일은 외부 저장소(Google Drive 등)에 저장되어 있으며, 링크를 통해 청취 가능합니다

## Summary (요약표)
| Exp ID | 날짜 | 사용 기술 | 곡명(소스 유형) | 비고 |
| :---: | :---: | :--- | :---: | :--- |
| **001** | 25.01.09 | htdemucs_6s | 기타 베이스 분리 예제 1 (Raw) | 베이스 성공적, 기타 잡음 |
| **002** | 25.01.10 | Butterworth | 기타 베이스 분리 예제 2 (Raw) | 기타 성공적, 베이스 라인 식별 불가 |
| **003** | 25.01.12 | NMF | 기타 베이스 분리 예제 2 (Raw) | 분리 실패 |
| **004** | 25.01.14 | OpenUnmix | 기타 베이스 분리 예제 2 (Raw) | 퍼스트 기타 성공적, 베이스 노트 식별 용이, 세컨 기타 식별 불가 |
| **005** | 25.01.16 | Demucs | 기타 베이스 분리 예제 2 (Raw) | 분리 성공, 잡음 및 블리딩 거의 없음 |
---

<details>
<summary><b>실험 상세 기록</b> - <i>Click to expand</i></summary>
<br>
   
###  Exp 001: 기타 베이스 분리 예제 1 (Raw Recording)
* **개요:** 기타와 베이스만 있는 트랙에서 둘을 온전히 분리할 수 있는지 검증
* **사용 음원:** 오디오 인터페이스 직렬로 직접 녹음한 일렉트릭 기타 2트랙, 일렉트릭 베이스 1트랙의 데모 (3분 30초 가량) 
* **사용 기술:**
    * Model: `htdemucs_6s`
    * Shifts: 1 (Default)
* **결과 분석:**
    * 기타만 존재하는 구간에서 기타 소리를 베이스로 착각함
    * 분리된 기타트랙의 선명도가 준수한데 비해 베이스 트랙은 볼륨의 울렁거림이 심함
* **향후 계획**
    * 더 짧은 샘플을 직접 녹음해 실험해볼 예정
    * 기타 1트랙, 베이스 1트랙으로 이루어진 음원 제작 후 실험

---
###  Exp 002: 기타 베이스 분리 예제 2 (Raw Recording)
* **개요:** Butterworth 필터를 이용해 주파수만으로 기타와 베이스를 분리할 수 있는지 검증
* **사용 음원:** Exp 001과 같은 소스에서 후반부만 잘라냄 (1분 가량) 
* **사용 기술:**
    * Frequency Filtering
      - LPF (Low Pass Filter): 낮은 주파수만 통과. → 베이스 분리용
      - HPF (High Pass Filter): 높은 주파수만 통과. → 기타 분리용
* **결과 분석:**
     * Cutoff Frequency에 따른 분리도 변화
       1) 100 ~ 200Hz
       - 베이스 트랙: 노트를 인식하기 어렵지만 기타 소리가 넘어오진 않음 -> bleeding 없음
       - 기타 트랙: 기타 소스는 일반적인 로우컷을 한 것처럼 깔끔함.
       2) 250 ~ 300Hz:
       - 베이스 트랙: 200Hz 대비좀 더 베이스의 라인을 인식하기 쉬워짐. 그러나 기타 소리가 세어나옴 bleeding 발생 250Hz 부터 미세하게 세컨기타의 타격 성분과 퍼스트 라인을 인식할 수 있음.
       - 기타 트랙: 200Hz에 비해 세컨 기타의 타격 성분이 많이 줄어들었음
* **향후 계획**
    * 더 짧은 샘플을 직접 녹음해 실험해볼 예정
    * 기타 1트랙, 베이스 1트랙으로 이루어진 음원 제작 후 실험
 
---

## Exp 003: NMF (Non-negative Matrix Factorization)
* **개요:** 단순 주파수 필터링(LPF/HPF)의 한계(주파수 대역이 겹치는 구간 분리 불가)를 극복하기 위해, 통계적 패턴 기반의 분리 알고리즘인 **NMF(비음수 행렬 분해)**를 도입하여 베이스와 기타 트랙 분리를 시도함.
* **사용 음원:** 기타 베이스 분리 예제 2 (Exp 002과 같은 소스)
* **사용 기술:**
    * Non-negative Matrix Factorization
       - 소리를 주파수 패턴($W$)과 시간 패턴($H$)의 곱으로 분해하여, 음색(Timbre)의 반복성을 기반으로 소스를 추정.
* **실험 과정:**
    * 행렬 차원 불일치 (Shape Mismatch) 오류 해결
       - 문제: 분해된 결과물 재조합 시 `ValueError` 발생.
       - 원인: `librosa.decompose` 수행 후 $W$(주파수 특징)와 $H$(시간 특징) 중 하나만 추출하여 계산함. 소리의 재구성을 위해서는 두 행렬의 외적(Outer Product)이 필요함.
       - 해결: $W, H$를 모두 반환받아 $W \times H$ 연산을 통해 원본 스펙트로그램 차원과 일치시킴.
    * `n_fft` 조정:1024, 2048(Default), 4096, 8192로 변경하며 주파수 해상도에 따른 분리도 관찰.
       - 유의미한 성능 향상 없음
    * Masking 기법 변환: Soft Masking vs Hard Masking 비교 실험.
       - 분리 성능 저하 발생
* **결과 분석:**
기대와 달리 기존 Frequency Filtering 방식보다 분리도가 하락함.
    * Severe Bleeding (블리딩 현상):
       - 기타 트랙에 베이스의 저음이, 베이스 트랙에 기타의 고음이 다수 혼입됨.
       - Hard Masking 적용 시 고주파 노이즈와 볼륨 울렁거림(Artifacts)이 심화됨.
    *Mel-Spectrogram 시각화 분석:
       - 시각화 결과, 두 트랙 모두 특정 주파수 대역이 깨끗하게 소거되지 않고 에너지가 잔존함을 확인.
       - 기타 트랙에서도 상당한 저음역대를 확인 가능, 베이스 트랙에서도 고음역 에너지 확인
       - 곡의 중반부(약 18초), 리드 기타가 솔로를 연주하며 한 옥타브 위로 올라가는 시점부터 분리 정도가 심화됨. 악기의 분리가 아닌 트랙 자체의 분리
* **향후 계획**
    * 딥러닝(Deep Learning) 기반의 비선형 모델(U-Net, Demucs 등)을 도입하여 Spectrogram의 패턴을 학습시키는 방식으로 전환 예정.

---

## Exp 004: OpenUnmix (UMX)
* **개요:**
    * 이전 실험(Exp 003, NMF)에서 확인된 선형 모델의 한계(블리딩, 저음 분리 실패)를 극복하기 위해, 시계열 데이터 학습에 특화된 딥러닝 모델인 **OpenUnmix(UMX)** 를 도입함.
    * 수학적 패턴 매칭이 아닌, Bi-LSTM(양방향 장단기 메모리) 신경망을 통해 시간의 흐름과 문맥을 파악하여 더 정교한 마스킹을 수행하고자 함.
* **사용 음원:** 기타 베이스 분리 예제 2 (Exp 002, 003과 동일 소스)
* **사용 기술:**
    * OpenUnmix (UMX): PyTorch 기반의 음악 소스 분리(MSS) 라이브러리.
    * Bi-LSTM (Bidirectional LSTM):과거와 미래의 정보를 모두 참조하여 현재 시점의 소리를 추정하는 순환 신경망 구조.
    * `torchaudio`, `Librosa`: 오디오 텐서 변환 및 로딩.
* **실험 과정:**
    * **오디오 백엔드 호환성 문제 해결**
        - 문제: Colab 환경에서 `torchaudio` 로드 시 `TorchCodec` 누락 오류 발생. 의존성 충돌 발생으로 추정
        - 해결: 안정성이 검증된 Librosa 라이브러리로 오디오를 로드(`numpy array`)한 후 `torch.tensor`로 우회 변환
    * **텐서 차원(Tensor Dimension) 전처리**
        - 문제: UMX 모델은 `[Batch, Channels, Time]` 형태의 3차원 스테레오 입력을 요구하나, 입력 데이터가 모노(1ch)이거나 배치 차원이 없어 오류 발생.
        - 해결: `unsqueeze(0)`로 배치 차원을 추가하고, 모노일 경우 `repeat(2, 1)`을 통해 강제로 스테레오(2ch)로 확장하는 전처리 파이프라인 구축.
    * **Model Confusion (모델 편향) 발견 및 수정**
        - 문제: 분리된 결과 청취 시, 베이스 트랙에서 기타 소리가 나고 기타(Other) 트랙에서 베이스 소리가 나는 현상 발견.
        - 해결: 청감 테스트를 통해 모델의 오분류를 확인하고, 출력 변수 할당 시 `Bass`와 `Other` 채널을 수동으로 교체(Swap)하여 바로잡음.
    * **Low Pass Filter 추가**
        - 문제: 청감 및 시각화 분석 결과 베이스 트랙에서 베이스 기타 노트가 비교적 좋게 분리되었음에도 고주파 잔음이 동시에 남음.
        - 해결: Exp002에서 사용한 주파수 필터(고음역대를 제거하기 위한 Low Pass 필터 사용)를 분리된 베이스 트랙에 도입해 노트 식별이 용이하게 함
* **결과 분석:**
    * 분리 성능의 향상:
        - NMF에서 발생했던 '물속에 있는 듯한(Webby)' 위상 왜곡과 블리딩 현상이 대부분 사라짐.
        - 베이스의 타격감(Transient)이 보존되며 단단한 소리로 추출됨.
    * AI 모델의 편향(Bias) 확인 (중요 Insight):
        - 기술적 분리 성능은 우수하나 장르적 특성 혹은 트랙에 따른 **Human-in-the-loop(사람의 검증)** 과정이 필수적임을 확인.
* **향후 계획:**
    * Transformer 기반 SOTA 모델 비교: LSTM 기반인 OpenUnmix를 넘어, 최신 SOTA(State-of-the-art) 모델인 **Demucs (Hybrid Transformer)**를 적용해보고 성능 차이 분석.

---

## Exp 005: 
* **개요:**
    *  Demucs 모델을 사용해 보다 좋은 결과의 분리 작업 시도
* **사용 음원:** 기타 베이스 분리 예제 2
* **사용 기술:**
    * Model: `htdemucs_6s`
* **결과 분석:**
    * 가장 깔끔한 분리 성공
    * **베이스**
        - 베이스 노트가 정확하게 실별되며 중저역대(Low_Midlde)의 펀치감이 굉장히 살아있음.
        - 특이사항: 실제 녹음된 원 베이스 소스 트랙보다도 음의 밀도가 올라간듯한 느낌
        - 저역에 과한 부밍 현상 없음, 기타 블리딩 및 고음역대 잡음 없음
        - 베이스 노트 음역이 높게 올라가는 경우 노트의 밀도가 흐려지는 현상 발견
    * **기타**
        - 세컨 기타와 퍼스트 기타 모두 높은 수준으로 분리됨
        - 세컨기타의 타격 성분 및 코드를 식별하기 용이함
        - 저역대에 울렁거림이 없고 로우컷이 된듯한 깔끔한 기타 트랙으로 분리됨
    * 시각화 결과에서도 베이스 음역과 기타가 전 트랙에 걸쳐 일관적으로 깔끔하게 분리됨을 확인 가능
* **향후 계획**
    * 세컨 기타 1트랙, 베이스 1트랙으로 이루어진 음원 제작 후 실험
    * demucs 모델 강화 및 파인튜닝

## Exp 005-1:
* **모델(Demucs) 파라미터 튜닝:**
    * shifts
        - 기능: 오디오를 0.5초씩 랜덤하게 밀어서 여러 번 분리한 뒤, 그 결과들의 평균을 냅니다.
        - 효과: 모델의 불확실성을 줄여 SDR(신호 대 잡음비)을 약 0.2dB 이상 향상시킵니다. 특히 베이스의 타격감(Transient)이 뭉개지는 현상을 완화하는 데 효과적입니다.
    * overlap (Segment Overlap)
        - 기능: 긴 곡을 자를 때 겹치는 구간의 비율을 조절합니다.
        - 효과: 기본값(0.25)보다 높이면 잘린 구간 사이의 이질감(Artifact)을 줄여주어, 베이스 라인이 끊기지 않고 매끄럽게 연결되도록 돕습니다.
     * htdemucs_ft (Fine-Tuned)
        - 파인튜닝을 위한 기초 모델
     * 결과:
        - 분리에 훨씬 많은 시간 소요됨 (약 10배 이상)
        - 분리된 결과물의 레벨(gain)이 작아짐
        - 베이스 노트가 더 선명해짐, 로우컷을 한듯이 저음역대의 벙벙되는 사운드가 정돈됨
        - 트랙 자체의 볼륨과 음역대는 깎였지만 카피 등의 정확한 음정 및 라인 인식이 필요한 작업에서는 더 용이한 결과물이 나옴
       
</details>
